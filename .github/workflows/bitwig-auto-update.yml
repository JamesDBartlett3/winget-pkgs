name: Auto-update Bitwig Studio

on:
  schedule:
    # Run every day at 10:00 AM UTC (check for new releases)
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches:
      - automation  # Only run on automation branch
    paths:
      - '.github/workflows/bitwig-auto-update.yml'
      - 'Tools/Update-BitwigManifest.ps1'

env:
  PACKAGE_IDENTIFIER: "bitwig.bitwig"
  PUBLISHER: "Bitwig GmbH"
  PACKAGE_NAME: "Bitwig Studio"

jobs:
  check-new-version:
    runs-on: windows-latest
    outputs:
      new-version: ${{ steps.version-check.outputs.new-version }}
      current-version: ${{ steps.version-check.outputs.current-version }}
      needs-update: ${{ steps.version-check.outputs.needs-update }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new Bitwig version
        id: version-check
        shell: pwsh
        run: |
          # Get the latest version from Bitwig download page
          try {
            $downloadPage = Invoke-WebRequest -Uri "https://www.bitwig.com/download/" -UseBasicParsing
            $versionPattern = 'Bitwig Studio ([\d\.]+)'
            $versionMatch = [regex]::Match($downloadPage.Content, $versionPattern)
            
            if ($versionMatch.Success) {
              $latestVersion = $versionMatch.Groups[1].Value
              Write-Host "Latest Bitwig version found: $latestVersion"
              
              # Check if this version already exists in manifests
              $manifestPath = "manifests\b\bitwig\bitwig\$latestVersion"
              $manifestExists = Test-Path $manifestPath
              
              if (-not $manifestExists) {
                Write-Host "New version detected: $latestVersion"
                echo "new-version=$latestVersion" >> $env:GITHUB_OUTPUT
                echo "needs-update=true" >> $env:GITHUB_OUTPUT
                
                # Get current latest version for comparison
                $existingVersions = Get-ChildItem "manifests\b\bitwig\bitwig\" -Directory | ForEach-Object { [version]$_.Name } | Sort-Object -Descending
                $currentLatest = $existingVersions[0].ToString()
                echo "current-version=$currentLatest" >> $env:GITHUB_OUTPUT
              } else {
                Write-Host "Version $latestVersion already exists"
                echo "needs-update=false" >> $env:GITHUB_OUTPUT
              }
            } else {
              Write-Host "Could not parse version from download page"
              echo "needs-update=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "Error checking for new version: $_"
            echo "needs-update=false" >> $env:GITHUB_OUTPUT
          }

  create-manifest:
    needs: check-new-version
    if: needs.check-new-version.outputs.needs-update == 'true'
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create new branch
        run: |
          $newVersion = "${{ needs.check-new-version.outputs.new-version }}"
          $branchName = "bitwig-studio-$newVersion"
          git checkout -b $branchName
          echo "BRANCH_NAME=$branchName" >> $env:GITHUB_ENV

      - name: Download installer and calculate checksum
        id: download
        shell: pwsh
        run: |
          $version = "${{ needs.check-new-version.outputs.new-version }}"
          $installerUrl = "https://www.bitwig.com/dl/Bitwig%20Studio/$version/installer_windows/"
          
          Write-Host "Downloading installer from: $installerUrl"
          
          # Create temp directory
          $tempDir = New-Item -ItemType Directory -Path "temp_download" -Force
          $installerPath = Join-Path $tempDir "bitwig_installer.msi"
          
          try {
            # Download the installer
            Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing
            
            # Calculate SHA256 checksum
            $hash = Get-FileHash -Path $installerPath -Algorithm SHA256
            $checksum = $hash.Hash
            
            Write-Host "Downloaded installer successfully"
            Write-Host "SHA256: $checksum"
            
            echo "checksum=$checksum" >> $env:GITHUB_OUTPUT
            echo "installer-url=$installerUrl" >> $env:GITHUB_OUTPUT
            
            # Clean up
            Remove-Item $tempDir -Recurse -Force
          } catch {
            Write-Host "Error downloading installer: $_"
            exit 1
          }

      - name: Create manifest files
        shell: pwsh
        run: |
          $version = "${{ needs.check-new-version.outputs.new-version }}"
          $checksum = "${{ steps.download.outputs.checksum }}"
          $installerUrl = "${{ steps.download.outputs.installer-url }}"
          $currentYear = (Get-Date).Year
          
          # Create manifest directory
          $manifestDir = "manifests\b\bitwig\bitwig\$version"
          New-Item -ItemType Directory -Path $manifestDir -Force
          
          # Create version manifest
          $versionManifest = @"
          # Created with automated workflow
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.version.1.10.0.schema.json
          
          PackageIdentifier: bitwig.bitwig
          PackageVersion: $version
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.10.0
          "@
          
          # Create installer manifest
          $installerManifest = @"
          # Created with automated workflow
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.installer.1.10.0.schema.json
          
          PackageIdentifier: bitwig.bitwig
          PackageVersion: $version
          Platform:
          - Windows.Desktop
          MinimumOSVersion: 10.0.0.0
          InstallerType: wix
          Scope: machine
          InstallModes:
          - interactive
          - silent
          - silentWithProgress
          UpgradeBehavior: uninstallPrevious
          FileExtensions:
          - bwproject
          - bwtemplate
          Installers:
          - Architecture: x64
            InstallerUrl: $installerUrl
            InstallerSha256: $checksum
          ManifestType: installer
          ManifestVersion: 1.10.0
          "@
          
          # Create locale manifest
          $localeManifest = @"
          # Created with automated workflow
          # yaml-language-server: `$schema=https://aka.ms/winget-manifest.defaultLocale.1.10.0.schema.json
          
          PackageIdentifier: bitwig.bitwig
          PackageVersion: $version
          PackageLocale: en-US
          Publisher: Bitwig GmbH
          PublisherUrl: https://www.bitwig.com/
          PublisherSupportUrl: https://www.bitwig.com/support/
          PrivacyUrl: https://www.bitwig.com/privacy_policy/
          Author: Bitwig GmbH
          PackageName: Bitwig Studio
          PackageUrl: https://www.bitwig.com/
          License: Proprietary
          LicenseUrl: https://shop.bitwig.com/order/terms_conditions.php
          Copyright: Copyright (c) $currentYear Bitwig GmbH
          CopyrightUrl: https://www.bitwig.com/copyright/
          ShortDescription: Modern music production and performance for Windows, macOS, and Linux.
          Moniker: bitwig
          Tags:
          - daw
          - midi
          - music
          - vst
          - vsti
          ReleaseNotesUrl: https://www.bitwig.com/dl/Bitwig%20Studio/$version/release_notes/
          ManifestType: defaultLocale
          ManifestVersion: 1.10.0
          "@
          
          # Write manifest files
          $versionManifest | Out-File -FilePath "$manifestDir\bitwig.bitwig.yaml" -Encoding UTF8
          $installerManifest | Out-File -FilePath "$manifestDir\bitwig.bitwig.installer.yaml" -Encoding UTF8
          $localeManifest | Out-File -FilePath "$manifestDir\bitwig.bitwig.locale.en-US.yaml" -Encoding UTF8
          
          Write-Host "Created manifest files for version $version"

      - name: Validate manifests
        shell: pwsh
        run: |
          $version = "${{ needs.check-new-version.outputs.new-version }}"
          $manifestDir = "manifests\b\bitwig\bitwig\$version"
          
          # Basic validation - check if files exist and have content
          $files = @(
            "bitwig.bitwig.yaml",
            "bitwig.bitwig.installer.yaml", 
            "bitwig.bitwig.locale.en-US.yaml"
          )
          
          foreach ($file in $files) {
            $filePath = Join-Path $manifestDir $file
            if (-not (Test-Path $filePath)) {
              Write-Host "Error: $file not found"
              exit 1
            }
            
            $content = Get-Content $filePath -Raw
            if ([string]::IsNullOrWhiteSpace($content)) {
              Write-Host "Error: $file is empty"
              exit 1
            }
          }
          
          Write-Host "All manifest files validated successfully"

      - name: Commit and push changes
        run: |
          $version = "${{ needs.check-new-version.outputs.new-version }}"
          git add .
          git commit -m "Add Bitwig Studio $version"
          git push origin $env:BRANCH_NAME

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: automation
          title: "Add Bitwig Studio ${{ needs.check-new-version.outputs.new-version }}"
          body: |
            ## New Package Version
            
            **Package**: Bitwig Studio  
            **Version**: ${{ needs.check-new-version.outputs.new-version }}  
            **Previous Version**: ${{ needs.check-new-version.outputs.current-version }}
            
            ### Changes
            - ✅ Downloaded and verified installer
            - ✅ Calculated SHA256 checksum
            - ✅ Created manifest files
            - ✅ Validated manifest structure
            
            ### Installer Details
            - **URL**: ${{ steps.download.outputs.installer-url }}
            - **SHA256**: ${{ steps.download.outputs.checksum }}
            
            ### Automation
            This PR was created automatically by the Bitwig Studio auto-update workflow.
            
            ---
            **Note**: Please review the manifest files and test the installation before merging.
          draft: false
          delete-branch: true

  notify:
    needs: [check-new-version, create-manifest]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Email Notification
        if: needs.check-new-version.outputs.needs-update == 'true' && needs.create-manifest.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "🎉 New Bitwig Studio ${{ needs.check-new-version.outputs.new-version }} Ready for Submission"
          to: ${{ secrets.EMAIL_TO }}
          from: "Bitwig Automation <${{ secrets.EMAIL_USERNAME }}>"
          html_body: |
            <h2>🎵 New Bitwig Studio Version Ready!</h2>
            
            <p><strong>Version:</strong> ${{ needs.check-new-version.outputs.new-version }}</p>
            <p><strong>Previous Version:</strong> ${{ needs.check-new-version.outputs.current-version }}</p>
            
            <h3>✅ What's Ready:</h3>
            <ul>
              <li>✅ Installer downloaded and verified</li>
              <li>✅ SHA256 checksum calculated</li>
              <li>✅ Complete manifest files created</li>
              <li>✅ Pull request created in your fork</li>
            </ul>
            
            <h3>🚀 Next Steps:</h3>
            <ol>
              <li><strong>Review the PR:</strong> <a href="https://github.com/${{ github.repository }}/pulls">View Pull Requests</a></li>
              <li><strong>Test the installation locally</strong> (optional)</li>
              <li><strong>Create upstream PR:</strong> Use the workflow management script</li>
            </ol>
            
            <h3>📋 Quick Commands:</h3>
            <pre>
            # Review and merge automation PR
            git checkout automation
            git pull origin automation
            
            # Create clean upstream PR
            .\Tools\Manage-ForkWorkflow.ps1 -Action create-pr
            # Enter: bitwig.bitwig
            # Enter: ${{ needs.check-new-version.outputs.new-version }}
            
            # Copy manifests from automation branch
            git checkout automation
            cp -r "manifests/b/bitwig/bitwig/${{ needs.check-new-version.outputs.new-version }}" /tmp/
            git checkout bitwig.bitwig-${{ needs.check-new-version.outputs.new-version }}
            cp -r "/tmp/${{ needs.check-new-version.outputs.new-version }}" "manifests/b/bitwig/bitwig/"
            git add manifests/
            git commit -m "Add Bitwig Studio ${{ needs.check-new-version.outputs.new-version }}"
            git push -u origin bitwig.bitwig-${{ needs.check-new-version.outputs.new-version }}
            </pre>
            
            <p><strong>PR Links:</strong></p>
            <ul>
              <li><a href="https://github.com/${{ github.repository }}/pulls">Your Fork PRs</a></li>
              <li><a href="https://github.com/microsoft/winget-pkgs/compare/master...${{ github.repository_owner }}:winget-pkgs:bitwig.bitwig-${{ needs.check-new-version.outputs.new-version }}">Create Upstream PR</a> (after pushing branch)</li>
            </ul>
            
            <hr>
            <p><small>This notification was sent by your Bitwig Studio automation. The manifest is ready for your review and submission!</small></p>

      - name: Create GitHub Issue Notification
        if: needs.check-new-version.outputs.needs-update == 'true' && needs.create-manifest.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-new-version.outputs.new-version }}';
            const previousVersion = '${{ needs.check-new-version.outputs.current-version }}';
            
            const issueBody = `## 🎵 New Bitwig Studio Version Ready for Submission
            
            **Version:** ${version}  
            **Previous Version:** ${previousVersion}
            
            ### ✅ Automation Completed:
            - [x] Downloaded installer from official Bitwig website
            - [x] Calculated SHA256 checksum
            - [x] Created complete manifest files
            - [x] Validated manifest structure
            - [x] Created pull request in this repository
            
            ### 🚀 Your Action Required:
            
            1. **Review the automated PR** in this repository
            2. **Test locally** (optional): \`winget install bitwig.bitwig --version ${version}\`
            3. **Create upstream PR** using the workflow management script
            
            ### 📋 Quick Commands:
            
            \`\`\`powershell
            # Create clean upstream PR
            .\\Tools\\Manage-ForkWorkflow.ps1 -Action create-pr
            # Enter package: bitwig.bitwig
            # Enter version: ${version}
            
            # Copy manifests and submit
            git checkout automation
            cp -r "manifests/b/bitwig/bitwig/${version}" /tmp/
            git checkout bitwig.bitwig-${version}
            cp -r "/tmp/${version}" "manifests/b/bitwig/bitwig/"
            git add manifests/
            git commit -m "Add Bitwig Studio ${version}"
            git push -u origin bitwig.bitwig-${version}
            \`\`\`
            
            ### 🔗 Links:
            - [View Automation PR](https://github.com/${{ github.repository }}/pulls)
            - [Create Upstream PR](https://github.com/microsoft/winget-pkgs/compare/master...${{ github.repository_owner }}:winget-pkgs:bitwig.bitwig-${version}) (after pushing branch)
            
            ---
            **This issue was created automatically by the Bitwig Studio automation.**
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `🎵 Bitwig Studio ${version} Ready for Submission`,
              body: issueBody,
              labels: ['automation', 'bitwig-studio', 'ready-for-submission']
            });

      - name: Send Discord Notification
        if: needs.check-new-version.outputs.needs-update == 'true' && needs.create-manifest.result == 'success'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d '{
                   "embeds": [{
                     "title": "🎵 New Bitwig Studio Release Ready!",
                     "description": "Version ${{ needs.check-new-version.outputs.new-version }} is ready for submission to winget-pkgs",
                     "color": 3066993,
                     "fields": [
                       {
                         "name": "Version",
                         "value": "${{ needs.check-new-version.outputs.new-version }}",
                         "inline": true
                       },
                       {
                         "name": "Previous Version", 
                         "value": "${{ needs.check-new-version.outputs.current-version }}",
                         "inline": true
                       },
                       {
                         "name": "Status",
                         "value": "✅ Manifests created and ready for review",
                         "inline": false
                       },
                       {
                         "name": "Next Steps",
                         "value": "1. Review PR in your fork\n2. Create upstream PR\n3. Submit to Microsoft",
                         "inline": false
                       }
                     ],
                     "footer": {
                       "text": "Bitwig Studio Automation"
                     },
                     "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                   }]
                 }' \
                 "$DISCORD_WEBHOOK"
          fi

      - name: Console Notification
        run: |
          if [ "${{ needs.check-new-version.outputs.needs-update }}" == "true" ]; then
            if [ "${{ needs.create-manifest.result }}" == "success" ]; then
              echo "✅ Successfully created manifests for Bitwig Studio ${{ needs.check-new-version.outputs.new-version }}"
              echo "📧 Notifications sent (if configured)"
              echo "🔗 Check your repository for the new PR: https://github.com/${{ github.repository }}/pulls"
              echo "⏭️ Ready for manual submission to Microsoft's winget-pkgs"
            else
              echo "❌ Failed to create manifest for Bitwig Studio ${{ needs.check-new-version.outputs.new-version }}"
            fi
          else
            echo "ℹ️ No new Bitwig Studio version found"
          fi
